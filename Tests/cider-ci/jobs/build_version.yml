  build_new_version:

    name: 'Build Minary'
    description: Build new Minary version packet
    run-on: 
      - type: branch
        include-match: ^development$    
 
    
    depends_on:
      httpreverseproxy_tests: {job: httpreverseproxy, type: job, states: [passed]}
      stylecop_tests: {job: stylecop_tests, type: job, states: [passed]}
      proxy_plugin_tests_tests: {job: proxy_plugin_tests, type: job, states: [passed]}


    context:
      task-defaults:
        max-auto-trials: 2
        traits:
          windows: true

      tasks:
        compile_minary_solution:
          timeout: 300
          name: Build new Minary version
          
          trial-attachments:
            logs:
             include-match: ^attachment[\w\d\-\_]*\.log$
             content-type: text/plain
             

          scripts:
            run_nuget_restore:
              body: |
                start /w .nuget\nuget.exe restore
                echo nuget.exe error level is %ERRORLEVEL%
                exit /b %ERRORLEVEL%  

            compile_new_minary_version:  
              ignore-state: false
              start-when:
                - script: run_nuget_restore   
                  states: [passed]  
              body: |
                start /w msbuild Minary.sln /t:Clean,Build /p:Configuration="Debug" /p:Platform="Mixed Platforms" /p:OutputPath=bin\Debug /flp:Summary;Verbosity=minimal;LogFile=attachment-msbuild-info.log /flp1:logfile=attachment-msbuild-error.log;errorsonly /flp2:logfile=attachment-msbuild-warning.log;warningsonly
                echo MSBuild error level is %ERRORLEVEL%
                exit /b %ERRORLEVEL%

            create_new_minary_package:
              ignore-state: false
              start-when:
                - script: compile_new_minary_version   
                  states: [passed]                
              body: |
                start /w /d BUILD BUILD.bat DEBUG
                echo BUILD.bat error level is %ERRORLEVEL%
                exit /b %ERRORLEVEL%